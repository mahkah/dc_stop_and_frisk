<head>
  <meta charset='utf-8' />
  <title>DC Stop and Frisks</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

  <link href='https://api.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />

  <style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
  }

  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
  }
  </style>
</head>

<body>
  <style>
  h1 {
    font-size: 20px;
    line-height: 30px;
  }

  h2 {
    font-size: 18px;
    line-height: 26px;
  }
  h3 {
    font-size: 14px;
    line-height: 20px;
    margin-bottom: 10px;
  }
  a {
    text-decoration: none;
    color: #2dc4b2;
  }
  #console {
    position: absolute;
    width: 240px;
    margin: 10px;
    padding: 10px 20px;
    background-color: white;
  }
  .map-overlay {
    position: absolute;
    bottom: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.8);
    margin-right: 20px;
    font-family: Arial, sans-serif;
    overflow: auto;
    border-radius: 3px;
  }

  #legend {
    padding: 10px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    line-height: 18px;
    height: 130px;
    margin-bottom: 40px;
    width: 250px;
  }
  .legend-key {
    display: inline-block;
    border-radius: 20%;
    width: 10px;
    height: 10px;
    margin-right: 5px;
  }

  #menu {
    background: #fff;
    position: absolute;
    z-index: 1;
    top: 10px;
    right: 10px;
    border-radius: 3px;
    width: 120px;
    border: 1px solid rgba(0,0,0,0.4);
    font-family: 'Open Sans', sans-serif;
  }
  #menu a {
    font-size: 13px;
    color: #404040;
    display: block;
    margin: 0;
    padding: 0;
    padding: 10px;
    text-decoration: none;
    border-bottom: 1px solid rgba(0,0,0,0.25);
    text-align: center;
  }
  #menu a:last-child {
    border: none;
  }
  #menu a:hover {
    background-color: #f8f8f8;
    color: #404040;
  }
  #menu a.active {
    background-color: #3887be;
    color: #ffffff;
  }
  #menu a.active:hover {
    background: #3074a4;
  }
  </style>

  <div id='map'></div>
  <nav id='menu'></nav>
  <div id='console'>
    <h1>Stop and Frisks</h1>
    <p>Data: <a href='https://mpdc.dc.gov/node/1310236'>Stop and frisk incidents</a> in Washington DC, 2010-2016</p>

    <h2>Filters</h2>
    <div class='session' id='ethn_buttons'>
      <h3>Race/Ethnicity</h3>
      <div class='row' id='ethn_filters'>
        <input id='all_race' type='radio' name='toggle_race' value='All' checked='checked'>
        <label for='all_race'>All</label>
        <input id='black' type='radio' name='toggle_race' value='Black'>
        <label for='black'>Black</label>
        <input id='white' type='radio' name='toggle_race' value='White'>
        <label for='white'>White</label>
        <input id='hisp' type='radio' name='toggle_race' value='Hispanic or Latino'>
        <label for='hisp'>Hispanic or Latino</label>
        <input id='azn' type='radio' name='toggle_race' value='Asian'>
        <label for='azn'>Asian</label>
        <input id='other' type='radio' name='toggle_race' value='Other'>
        <label for='other'>Other</label>
      </div>
    </div>
    <div class='session' id='gender_buttons'>
      <h3>Gender</h3>
      <div class='row' id='gender_filters'>
        <input id='all_gender' type='radio' name='toggle_gender' value='All' checked='checked'>
        <label for='all_gender'>All</label>
        <input id='male' type='radio' name='toggle_gender' value='Male'>
        <label for='male'>Men</label>
        <input id='women' type='radio' name='toggle_gender' value='Female'>
        <label for='women'>Women</label>
      </div>
    </div>
    <div class='session' id='sliderbar'>
      <h3>Year: <label id='active-year'>All Years</label></h3>
      <button class='btn' id='all_years_btn'>All Years</button>
      <input id='year_slider' class='row' type='range' min='2010' max='2016' step='1' value='2016'/>
    </div>
    <div class='session' id='sliderbar'>
      <h3>Hour: <label id='active-hour'>All Times</label></h3>
      <button class='btn' id='all_time_btn'>All Times</button>
      <input id='time_slider' class='row' type='range' min='0' max='23' step='1' value='22'/>
    </div>
    <!--
    <h2>Info</h2>
    <div id='pd'><p>Hover over an incident for more information.</p></div>
    -->
  </div>

  <div class='map-overlay' id='legend'></div>


  <script>
  // Config
  mapboxgl.accessToken = 'pk.eyJ1IjoibWFoa2FoIiwiYSI6ImNqZW9zNHBvaTBhc2YzM2x0OWg3aXZ5dTAifQ.F1uwBes6jRJHdwqeSMiA-w';

  // Load Datasets
  function loadData(filename) {
    return $.ajax({
      url:"https://raw.githubusercontent.com/mahkah/dc_stop_and_frisk/master/transformed_data/" + filename,
      dataType: "json",
      success: console.log(filename + " successfully loaded."),
      error: function (xhr) {
        alert(xhr.statusText)
      }
    });
  }

  var psaGEOJSON = loadData("Police_Service_Areas_collected.geojson");
  var censusTractGEOJSON = loadData("Census_Tracts_in_2010_collected.geojson");
  var neighborhoodGEOJSON = loadData("Neighborhood_Clusters_collected.geojson");
  var policeSectorGEOJSON = loadData("Police_Sectors_collected.geojson");
  var wardGEOJSON = loadData("Ward_from_2012_collected.geojson");
  var sffcGEOJSON = loadData("SF_Field_Contact_02202018_locations.geojson");

  // Load map
  var map = new mapboxgl.Map({
    container: 'map', // container element id
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-77.030034, 38.901863], // initial map center in [lon, lat]
    zoom: 11
  });

  // Data Layers
  map.on('load', function() {
    var filter_ethn = ['!=', ['string', ['get', 'race']], 'placeholder'];
    var filter_gen = ['!=', ['string', ['get', 'gen']], 'placeholder'];
    var filter_hour = ['!=', ['number', ['get', 'hr']], 25];
    var filter_year = ['!=', ['number', ['get', 'yr']], 25];

    // Incident Cluster Layer
    map.addSource('sffc_cluster', {
      type: 'geojson',
      data: sffcGEOJSON.responseJSON,
      cluster: true,
      clusterMaxZoom: 29,
      clusterRadius: 30
    });
    // Single Incidents
    map.addLayer({
      id: 'Individual Incidents',
      type: 'circle',
      source: 'sffc_cluster',
      filter: ['all', filter_ethn, filter_gen, filter_year, filter_hour],
      paint: {
        "circle-color": "rgb(253,231,37)",
        "circle-radius": 4,
        "circle-stroke-width": 1,
        "circle-stroke-color": "#111",
        "circle-opacity": 0.7
      }
    }, 'admin-2-boundaries-dispute'
  );
  // Clusters
  map.addLayer({
    id: "clusters",
    type: "circle",
    source: "sffc_cluster",
    filter:  ['all', ["has", "point_count"]],
    paint: {
      "circle-color": [
        "interpolate",
        ["exponential", 2.5],
        ["get", "point_count"],
        1, 'rgb(253,231,37)',
        6, 'rgb(220,228,23)',
        16, 'rgb(184,222,41)',
        32, 'rgb(147,216,64)',
        56, 'rgb(116,208,85)',
        88, 'rgb(85,198,102)',
        130, 'rgb(60,188,117)',
        181, 'rgb(41,175,127)',
        243, 'rgb(33,163,134)',
        316, 'rgb(32,150,139)',
        401, 'rgb(35,137,141)',
        499, 'rgb(40,124,142)',
        609, 'rgb(45,112,142)',
        733, 'rgb(50,99,142)',
        871, 'rgb(57,84,140)',
        1024, 'rgb(63,71,136)',
        1192, 'rgb(69,55,129)',
        1375, 'rgb(72,39,119)',
        1574, 'rgb(72,21,104)',
        1789, 'rgb(68,13,83)'
      ],
      "circle-radius": [
        "interpolate",
        ["exponential", 2.5],
        ["get", "point_count"],
        1, 5,
        6, 6,
        16, 7,
        32, 8,
        56, 9,
        88, 10,
        130, 11,
        181, 12,
        243, 13,
        316, 14,
        401, 15,
        499, 16,
        609, 17,
        733, 18,
        871, 19,
        1024, 20,
        1192, 21,
        1375, 22,
        1574, 23,
        1789, 24
      ],
      'circle-opacity': 0.7
    }
  });
  // Cluster Labels
  map.addLayer({
    id: "Individual Incidents Count",
    type: "symbol",
    source: "sffc_cluster",
    filter:  ['all', ["has", "point_count"]],
    layout: {
      "text-field": "{point_count_abbreviated}",
      "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
      "text-size": 12
    }
  });
  // Cluster Layer Default filters
  var filterEthnCluster = function(i) {
    return true;
  }
  var filterGenderCluster = function(i) {
    return true;
  }
  var filterHourCluster = function(i) {
    return true;
  }
  var filterYearCluster = function(i) {
    return true;
  }


  // Choropleth Maps
  /** Appends an array of attributes on all the incidents that occured in each polygon. */
  function collectProperties(polygonGEOJSON, incidentGEOJSON, filterArray) {
    var collectedGEOJSON = turf.collect(polygonGEOJSON, incidentGEOJSON, filterArray[0], filterArray[0]);
    for (var i = 1; i < filterArray.length; i++) {
      collectedGEOJSON = turf.collect(collectedGEOJSON, incidentGEOJSON, filterArray[i], filterArray[i]);
    }
    return collectedGEOJSON;
  }

  /** Initializes the sets used for filtering incidents occuring within each polygon. */
  function initializeIndices(collectedGEOJSON, filterArray) {
    var initialIndex = [];
    for (var i = 0; i < collectedGEOJSON.features.length; i++) {
      initialIndex[i] = new Set(Array.apply(null, {length: collectedGEOJSON.features[i].properties.hr.length}).map(Number.call, Number));
    }
    var indicesSetsArray = [initialIndex];
    for (var j = 1; j < filterArray.length; j++) {
      indicesSetsArray.push(initialIndex);
    }
    return indicesSetsArray;
  }

  /** Plots choropleth maps. */
  function plotChoropleth(collectedGEOJSON, sourceName, layerName) {
    var maxSFFC = 0;
    for (var i = 0; i < collectedGEOJSON.features.length; i++) {
      collectedGEOJSON.features[i].properties.sffcCount = collectedGEOJSON.features[i].properties.hr.length;
      if (collectedGEOJSON.features[i].properties.sffcCount > maxSFFC) {
        maxSFFC = collectedGEOJSON.features[i].properties.sffcCount;
      }
    }
    var colorRange = [];
    for (var i = 0; i < 20; i++) {
      colorRange[i] = maxSFFC * (i / 19);
    }
    map.addSource(sourceName, {
      type: 'geojson',
      data: collectedGEOJSON
    });
    map.addLayer({
      'id': layerName,
      'type': 'fill',
      'source': sourceName,
      'paint': {
        'fill-color': [
          'interpolate',
          ['linear'],
          ['get', 'sffcCount'],
          colorRange[0], 'rgb(253,231,37)',
          colorRange[1], 'rgb(220,228,23)',
          colorRange[2], 'rgb(184,222,41)',
          colorRange[3], 'rgb(147,216,64)',
          colorRange[4], 'rgb(116,208,85)',
          colorRange[5], 'rgb(85,198,102)',
          colorRange[6], 'rgb(60,188,117)',
          colorRange[7], 'rgb(41,175,127)',
          colorRange[8], 'rgb(33,163,134)',
          colorRange[9], 'rgb(32,150,139)',
          colorRange[10], 'rgb(35,137,141)',
          colorRange[11], 'rgb(40,124,142)',
          colorRange[12], 'rgb(45,112,142)',
          colorRange[13], 'rgb(50,99,142)',
          colorRange[14], 'rgb(57,84,140)',
          colorRange[15], 'rgb(63,71,136)',
          colorRange[16], 'rgb(69,55,129)',
          colorRange[17], 'rgb(72,39,119)',
          colorRange[18], 'rgb(72,21,104)',
          colorRange[19], 'rgb(68,13,83)'
        ],
        'fill-opacity': 0.7
      }
    }, 'Individual Incidents')
    map.setLayoutProperty(layerName, 'visibility', 'none');
  }

  // Define attributes to collect from individual incidents for filtering
  var filterAttributes = ['race', 'gen', 'age', 'yr', 'mon', 'day', 'hr'];
  // Keep track of whether or not we actually need to filter on each attribute
  var filterOn = [];
  for (var i = 0; i < filterAttributes.length; ++i) {
    filterOn.push(false)
  }
  // Police Service Area Layer
  var psaProp = psaGEOJSON.responseJSON;
  var psaIndices = initializeIndices(psaProp, filterAttributes);
  plotChoropleth(psaProp, 'psas', 'Police Service Areas');
  // Census Tract Layer
  var censusTractProp = censusTractGEOJSON.responseJSON;
  var censusTractIndices = initializeIndices(censusTractProp, filterAttributes);
  plotChoropleth(censusTractProp, 'censusTracts', 'Census Tracts');
  // Neighborhood Layer
  var neighborhoodProp = neighborhoodGEOJSON.responseJSON;
  var neighborhoodIndices = initializeIndices(neighborhoodProp, filterAttributes);
  plotChoropleth(neighborhoodProp, 'neighborhoods', 'Neighborhoods');
  // Police Sector Layer
  var policeSectorProp = policeSectorGEOJSON.responseJSON;
  var policeSectorIndices = initializeIndices(policeSectorProp, filterAttributes);
  plotChoropleth(policeSectorProp, 'policeSectors', 'Police Sectors');
  // Ward Layer
  var wardProp = wardGEOJSON.responseJSON;
  var wardIndices = initializeIndices(wardProp, filterAttributes);
  plotChoropleth(wardProp, 'wards', 'Wards');



  // Filters
  /** Takes the intersection of two or more sets. */
  function intersect(sets) {
    var minSize = sets[0].size;
    var shortSetIndex = 0;
    for (var i = 1; i < sets.length; i++) {
      if (sets[i].size < minSize) {
        minSize = sets[i].size;
        shortSetIndex = i;
      }
    }
    // var shortSetIndex = sets.reduce(function(minI,el,i,arr) {return el.size<arr[minI].size ? i : minI;}, 0);
    var shortSet = sets.splice(shortSetIndex, 1);
    var count = sets.length;
    var result = new Set(shortSet[0]);
    shortSet[0].forEach(item => {
      var i = count;
      var allHave = true;
      while (i--){
        allHave = sets[i].has(item)
        if (!allHave) { break }
      }
      if (!allHave) {
        result.delete(item);
      }
    })
    return result;
  }

  /** Updates choropleth map layers. */
  function updateChoropleth(collectedGEOJSON, indicesSetsArray, filterArray, sourceName, layerName) {
    var maxSFFC = 0;
    for (var i = 0; i < collectedGEOJSON.features.length; i++) {
      var indicesSets = [];
      for (var j = 0; j < filterArray.length; j++) {
        if (filterOn[j]) { indicesSets.push(indicesSetsArray[j][i]) }
      }
      if (indicesSets.length === 0) {
        var intersection_indices = indicesSetsArray[0][i]
      } else if (indicesSets.length === 1) {
        var intersection_indices = indicesSets[0]
      } else {
        var intersection_indices = intersect(indicesSets);
      }
      collectedGEOJSON.features[i].properties.sffcCount = intersection_indices.size;

      if (collectedGEOJSON.features[i].properties.sffcCount > maxSFFC) {
        maxSFFC = collectedGEOJSON.features[i].properties.sffcCount;
      }
    }
    var colorRange = []
    for (var i = 0; i < 20; i++) {
      colorRange[i] = maxSFFC * (i / 19);
    }
    map.getSource(sourceName).setData(collectedGEOJSON);
    map.setPaintProperty(layerName, 'fill-color', [
      'interpolate',
      ['linear'],
      ['get', 'sffcCount'],
      colorRange[0], 'rgb(253,231,37)',
      colorRange[1], 'rgb(220,228,23)',
      colorRange[2], 'rgb(184,222,41)',
      colorRange[3], 'rgb(147,216,64)',
      colorRange[4], 'rgb(116,208,85)',
      colorRange[5], 'rgb(85,198,102)',
      colorRange[6], 'rgb(60,188,117)',
      colorRange[7], 'rgb(41,175,127)',
      colorRange[8], 'rgb(33,163,134)',
      colorRange[9], 'rgb(32,150,139)',
      colorRange[10], 'rgb(35,137,141)',
      colorRange[11], 'rgb(40,124,142)',
      colorRange[12], 'rgb(45,112,142)',
      colorRange[13], 'rgb(50,99,142)',
      colorRange[14], 'rgb(57,84,140)',
      colorRange[15], 'rgb(63,71,136)',
      colorRange[16], 'rgb(69,55,129)',
      colorRange[17], 'rgb(72,39,119)',
      colorRange[18], 'rgb(72,21,104)',
      colorRange[19], 'rgb(68,13,83)'
    ]);
  }

  /** Updates the filters for all map layers. */
  function filterUpdate() {
    // Single incidents
    map.setFilter('Individual Incidents', ['all', filter_ethn, filter_gen, filter_year, filter_hour]);
    // Cluster Layer
    var clusterData = sffcGEOJSON.responseJSON.features.filter(filterEthnCluster);
    var clusterData = clusterData.filter(filterGenderCluster);
    var clusterData = clusterData.filter(filterYearCluster);
    var clusterData = clusterData.filter(filterHourCluster);
    var clusterData = turf.featureCollection(clusterData);
    map.getSource('sffc_cluster').setData(clusterData);
    // Choropleth layers
    updateChoropleth(psaProp, psaIndices, filterAttributes, 'psas', 'Police Service Areas');
    updateChoropleth(censusTractProp, censusTractIndices, filterAttributes, 'censusTracts', 'Census Tracts');
    updateChoropleth(neighborhoodProp, neighborhoodIndices, filterAttributes, 'neighborhoods', 'Neighborhoods');
    updateChoropleth(policeSectorProp, policeSectorIndices, filterAttributes, 'policeSectors', 'Police Sectors');
    updateChoropleth(wardProp, wardIndices, filterAttributes, 'wards', 'Wards');
  }

  //** Resets the sets of indices to include all incidents */
  function allFilter(collectedGEOJSON, indicesSetsArray, filterArray, attribute) {
    indicesSetsArray[filterArray.indexOf(attribute)] = [];
    for (var i = 0; i < collectedGEOJSON.features.length; i++) {
      indicesSetsArray[filterArray.indexOf(attribute)][i] = new Set(Array.apply(null, {length: collectedGEOJSON.features[i].properties.hr.length}).map(Number.call, Number));;
    }
    filterOn[filterArray.indexOf(attribute)] = false;
  }

  //** Modifies the sets of indices to match a particular variable */
  function singleValueFilter(collectedGEOJSON, indicesSetsArray, filterArray, attribute, value) {
    var filterNumber = filterArray.indexOf(attribute)
    indicesSetsArray[filterNumber] = [];
    for (var i = 0; i < collectedGEOJSON.features.length; i++) {
      indicesSetsArray[filterNumber][i] = new Set();
      var j = collectedGEOJSON.features[i].properties[attribute].indexOf(value);
      while (j != -1) {
        indicesSetsArray[filterNumber][i].add(j);
        j = collectedGEOJSON.features[i].properties[attribute].indexOf(value, j + 1);
      }
    }
    filterOn[filterArray.indexOf(attribute)] = true;
  }

  // Ethnicity Filter
  document.getElementById('ethn_filters').addEventListener('change', function(e) {
    var race = e.target.value;
    if (race === 'All') {
      // Single Incidents
      filter_ethn = ['!=', ['string', ['get', 'race']], 'placeholder'];
      // Incident Clusters
      filterEthnCluster = function(i) {
        return true;
      }
      // Choropleth layers
      allFilter(psaProp, psaIndices, filterAttributes, 'race');
      allFilter(censusTractProp, censusTractIndices, filterAttributes, 'race');
      allFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'race');
      allFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'race');
      allFilter(wardProp, wardIndices, filterAttributes, 'race');
    } else {
      // Single Incidents
      filter_ethn = ['match', ['get', 'race'], race, true, false];
      // Incident Clusters
      filterEthnCluster = function(i) {
        return i.properties.race === race;
      }
      // Choropleth layers
      singleValueFilter(psaProp, psaIndices, filterAttributes, 'race', race);
      singleValueFilter(censusTractProp, censusTractIndices, filterAttributes, 'race', race);
      singleValueFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'race', race);
      singleValueFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'race', race);
      singleValueFilter(wardProp, wardIndices, filterAttributes, 'race', race);
    }
    filterUpdate();
  });

  // Gender Filter
  document.getElementById('gender_filters').addEventListener('change', function(e) {
    var gen = e.target.value;
    if (gen === 'All') {
      // Single Incidents
      filter_gen = ['!=', ['string', ['get', 'gen']], 'placeholder'];
      // Incident Clusters
      filterGenderCluster = function(i) {
        return true;
      }
      // Choropleth layers
      allFilter(psaProp, psaIndices, filterAttributes, 'gen');
      allFilter(censusTractProp, censusTractIndices, filterAttributes, 'gen');
      allFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'gen');
      allFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'gen');
      allFilter(wardProp, wardIndices, filterAttributes, 'gen');
    } else {
      // Single Incidents
      filter_gen = ['match', ['get', 'gen'], gen, true, false];
      // Incident Clusters
      filterGenderCluster = function(i) {
        return i.properties.gen === gen;
      }
      // Choropleth layers
      singleValueFilter(psaProp, psaIndices, filterAttributes, 'gen', gen);
      singleValueFilter(censusTractProp, censusTractIndices, filterAttributes, 'gen', gen);
      singleValueFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'gen', gen);
      singleValueFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'gen', gen);
      singleValueFilter(wardProp, wardIndices, filterAttributes, 'gen', gen);
    }
    filterUpdate();
  });

  // Year Slider
  document.getElementById('year_slider').addEventListener('input', function(e) {
    var yr = parseInt(e.target.value);
    // Update Filter Control's Display
    document.getElementById('active-year').innerText = yr;
    // Single Incidents
    filter_year = ['==', ['number', ['get', 'yr']], yr];
    // Incident Clusters
    filterYearCluster = function(i) {
      return i.properties.yr === yr;
    }
    // Choropleth layers
    singleValueFilter(psaProp, psaIndices, filterAttributes, 'yr', yr);
    singleValueFilter(censusTractProp, censusTractIndices, filterAttributes, 'yr', yr);
    singleValueFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'yr', yr);
    singleValueFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'yr', yr);
    singleValueFilter(wardProp, wardIndices, filterAttributes, 'yr', yr);
    // Refresh Filters
    filterUpdate();
  });

  // All Years Button
  document.getElementById('all_years_btn').addEventListener('click', function(e) {
    // Update Filter Control's Display
    document.getElementById('active-year').innerText = 'All Years';
    // Single Incidents
    filter_year = ['!=', ['number', ['get', 'yr']], 25];
    // Incident Clusters
    filterYearCluster = function(i) {
      return true;
    }
    // Choropleth layers
    allFilter(psaProp, psaIndices, filterAttributes, 'yr');
    allFilter(censusTractProp, censusTractIndices, filterAttributes, 'yr');
    allFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'yr');
    allFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'yr');
    allFilter(wardProp, wardIndices, filterAttributes, 'yr');
    // Refresh Filters
    filterUpdate();
  });

  // Hour Slider
  document.getElementById('time_slider').addEventListener('input', function(e) {
    var hour = parseInt(e.target.value);
    // Update Filter Control's Display
    var ampm = hour >= 12 ? 'PM' : 'AM';
    var hour12 = hour % 12 ? hour % 12 : 12;
    document.getElementById('active-hour').innerText = hour12 + ampm;
    // Single Incidents
    filter_hour = ['==', ['number', ['get', 'hr']], hour];
    // Incident Clusters
    filterHourCluster = function(i) {
      return i.properties.hr === hour;
    }
    // Choropleth layers
    singleValueFilter(psaProp, psaIndices, filterAttributes, 'hr', hour);
    singleValueFilter(censusTractProp, censusTractIndices, filterAttributes, 'hr', hour);
    singleValueFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'hr', hour);
    singleValueFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'hr', hour);
    singleValueFilter(wardProp, wardIndices, filterAttributes, 'hr', hour);
    // Refresh Filters
    filterUpdate();
  });

  // All Time Button
  document.getElementById('all_time_btn').addEventListener('click', function(e) {
    // Update Filter Control's Display
    document.getElementById('active-hour').innerText = 'All Times';
    // Single Incidents
    filter_hour = ['!=', ['number', ['get', 'hour']], 25];
    // Incident Clusters
    filterHourCluster = function(i) {
      return true;
    }
    // Choropleth layers
    allFilter(psaProp, psaIndices, filterAttributes, 'hr');
    allFilter(censusTractProp, censusTractIndices, filterAttributes, 'hr');
    allFilter(neighborhoodProp, neighborhoodIndices, filterAttributes, 'hr');
    allFilter(policeSectorProp, policeSectorIndices, filterAttributes, 'hr');
    allFilter(wardProp, wardIndices, filterAttributes, 'hr');
    // Refresh Filters
    filterUpdate();
  });

  // // Build Legend
  // var layers = ['White', 'Black', 'Asian', 'American Indian/Alaska Native', 'Native Hawaiian/Other Pacific Islander', 'Unknown'];
  // var colors = ['#fbb03b', '#223b53', '#3bb2d0', '#3bb2d0', '#3bb2d0', '#111111'];
  // for (i = 0; i < layers.length; i++) {
  //   var layer = layers[i];
  //   var color = colors[i];
  //   var item = document.createElement('div');
  //   var key = document.createElement('span');
  //   key.className = 'legend-key';
  //   key.style.backgroundColor = color;
  //   var value = document.createElement('span');
  //   value.innerHTML = layer;
  //   item.appendChild(key);
  //   item.appendChild(value);
  //   legend.appendChild(item);
  // }

}); // End of on map load actions

// Tooltip
// map.on('mousemove', function(e) {
//   var incident = map.queryRenderedFeatures(e.point, {
//     layers: ['Individual Incidents']
//   });
//
//   if (incident.length > 0) {
//     document.getElementById('pd').innerHTML = '<h3><strong>' + incident[0].properties.gen + '</strong></h3>';
//   } else {
//     document.getElementById('pd').innerHTML = '<p>Hover over an incident for more information.</p>';
//   }
// });

// Layer Selection
var toggleableLayers = {
  'Individual Incidents': ['Individual Incidents', 'clusters', 'Individual Incidents Count'],
  'Wards': ['Wards'],
  'Neighborhoods': ['Neighborhoods'],
  'Police Sectors': ['Police Sectors'],
  'Police Service Areas': ['Police Service Areas'],
  'Census Tracts': ['Census Tracts']
  }
var defaultLayerIds = ['Individual Incidents']
Object.keys(toggleableLayers).forEach(function(key, index) {
  // Build buttons for each layer
  var link = document.createElement('a');
  link.href = '#';
  if (defaultLayerIds.indexOf(key) >= 0){
    link.className = 'active';
  } else {
    link.className = '';
  }
  link.textContent = key;
  // Add interactivity
  link.onclick = function (e) {
    var clickedLayer = toggleableLayers[this.textContent];
    e.preventDefault();
    e.stopPropagation();
    var visibility = map.getLayoutProperty(clickedLayer[0], 'visibility');
    if (visibility === 'visible') {
      this.className = '';
      for (var i = 0; i < clickedLayer.length; i++) {
        map.setLayoutProperty(clickedLayer[i], 'visibility', 'none');
      }
    } else {
      this.className = 'active';
      for (var i = 0; i < clickedLayer.length; i++) {
        map.setLayoutProperty(clickedLayer[i], 'visibility', 'visible');
      }
    }
  };
  var layers = document.getElementById('menu');
  layers.appendChild(link);
});

</script>
</body>
